<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat - QuizBot PE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="chatbot.css">
</head>
<body>

    <!-- Áudio de Fundo -->
    <audio id="bg-music" autoplay loop>
        <source src="assets/audio/chico_beat.m4a" type="audio/mpeg">
    </audio>

    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <!-- Lado Esquerdo: Avatar + Texto -->
            <div class="header-left">
                <div class="avatar-circle">
                    <!-- A imagem será carregada via JS -->
                    <img id="profile-img" src="" alt="Avatar">
                </div>
                <div class="header-text">
                    <span style="font-weight: 700;">Falando com:</span>
                    <span id="char-name" style="font-weight: 800;">Personagem</span>
                </div>
            </div>
            
            <!-- Lado Direito: Pontos + Sair (Estilo Original) -->
            <div class="header-right">
                <div class="score-box">
                    <span>Pontos:</span>
                    <span id="score-display">0</span>
                    <i class="fa-solid fa-coins"></i>
                </div>
                
                <button class="btn-exit" onclick="window.location.href='login.html'">Sair</button>
            </div>
        </div>

        <!-- Mensagens -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- Input -->
        <div class="chat-input-area">
            <label class="file-upload-label" for="file-input">
                <i class="fa-solid fa-paperclip"></i>
            </label>
            <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(this)">
            
            <input type="text" id="chat-input" class="chat-input" placeholder="Digite sua pergunta..." onkeypress="handleKeyPress(event)">
            
            <button class="btn-send" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // --- INICIALIZAÇÃO ---
        const personagem = localStorage.getItem('personagem_escolhido') || 'Capivara Turista';
        let pontuacao = parseInt(localStorage.getItem('pontuacao_atual')) || 0;
        let imagemAtual = null;
        let interacoes = 0;

        // Mapeamento das imagens de perfil
        // Certifique-se que essas imagens estão na pasta 'assets/'
        // As chaves devem ser IDÊNTICAS ao nome salvo no localStorage na página anterior
        const perfis = {
            'João Frevo': 'assets/joaofrevo_perfil.png',
            'Maria Maracatu': 'assets/mariamaracatu_perfil.png',
            'Capivara Turista': 'assets/capivaraturista_perfil.png'
        };

        // Define a imagem e o texto
        // Fallback para capivara se não achar a imagem específica
        const imgPath = perfis[personagem] || 'assets/capivaraturista_perfil.png'; 
        
        document.getElementById('profile-img').src = imgPath;
        document.getElementById('char-name').innerText = personagem;
        document.getElementById('score-display').innerText = pontuacao;

        // Mensagem inicial
        addMessage('bot', `Olá! Eu sou ${personagem}. Envie uma foto de um ponto turístico e me pergunte sobre ele!`);

        // --- FUNÇÕES ---
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagemAtual = e.target.result; 
                    const imgHTML = `<img src="${e.target.result}" class="uploaded-preview"> <i>Imagem carregada.</i>`;
                    addMessage('user', imgHTML);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addMessage(sender, htmlContent) {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.classList.add('message', sender);
            div.innerHTML = htmlContent;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const inputField = document.getElementById('chat-input');
            const text = inputField.value.trim();

            if (!text && !imagemAtual) return;

            if (text) addMessage('user', text);
            inputField.value = '';

            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'bot');
            loadingDiv.innerText = 'Digitando...';
            loadingDiv.id = loadingId;
            document.getElementById('chat-messages').appendChild(loadingDiv);

            try {
                // Simulação de resposta do backend
                await new Promise(r => setTimeout(r, 1500));
                
                let respostaTexto = "Interessante! Esse lugar tem muita história.";
                let pontosGanhos = 10;

                document.getElementById(loadingId).remove();
                addMessage('bot', respostaTexto);
                
                pontuacao += pontosGanhos;
                localStorage.setItem('pontuacao_atual', pontuacao);
                document.getElementById('score-display').innerText = pontuacao;
                addMessage('bot', `<b>+${pontosGanhos} Pontos!</b>`);

                imagemAtual = null; 
                interacoes++;

                if (pontuacao >= 50 || interacoes >= 3) {
                    setTimeout(() => {
                        window.location.href = "final.html";
                    }, 2000);
                }

            } catch (error) {
                console.error(error);
            }
        }
    </script>
</body>
</html>